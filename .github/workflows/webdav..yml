name: ä¸Šä¼ éŸ³ä¹åˆ°äº‘ç›˜

on:
  workflow_dispatch:
    inputs:
      compression_level:
        description: 'åŽ‹ç¼©çº§åˆ« (1-9, 9ä¸ºæœ€é«˜åŽ‹ç¼©)'
        required: false
        default: '6'
        type: string
      upload_path:
        description: 'äº‘ç›˜ä¸Šä¼ è·¯å¾„'
        required: false
        default: '/music/'
        type: string
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ‰§è¡Œ
    - cron: '0 2 * * *'
  push:
    paths:
      - 'public/music/**'
      - '.github/workflows/upload-music.yml'

permissions:
  contents: read

jobs:
  compress-and-upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ£€æŸ¥éŸ³ä¹æ–‡ä»¶
        id: check-music
        run: |
          if [ -d "public/music" ] && [ "$(find public/music -type f \( -name "*.mp3" -o -name "*.flac" -o -name "*.wav" -o -name "*.m4a" -o -name "*.ogg" -o -name "*.aac" \) | wc -l)" -gt 0 ]; then
            echo "has_music=true" >> $GITHUB_OUTPUT
            echo "music_count=$(find public/music -type f \( -name "*.mp3" -o -name "*.flac" -o -name "*.wav" -o -name "*.m4a" -o -name "*.ogg" -o -name "*.aac" \) | wc -l)" >> $GITHUB_OUTPUT
          else
            echo "has_music=false" >> $GITHUB_OUTPUT
            echo "music_count=0" >> $GITHUB_OUTPUT
          fi

      - name: æ˜¾ç¤ºéŸ³ä¹æ–‡ä»¶ä¿¡æ¯
        if: steps.check-music.outputs.has_music == 'true'
        run: |
          echo "å‘çŽ° ${{ steps.check-music.outputs.music_count }} ä¸ªéŸ³ä¹æ–‡ä»¶"
          echo "éŸ³ä¹æ–‡ä»¶åˆ—è¡¨ï¼š"
          find public/music -type f \( -name "*.mp3" -o -name "*.flac" -o -name "*.wav" -o -name "*.m4a" -o -name "*.ogg" -o -name "*.aac" \) -exec ls -lh {} \;

      - name: å®‰è£…åŽ‹ç¼©å·¥å…·
        if: steps.check-music.outputs.has_music == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y zip unzip

      - name: åˆ›å»ºåŽ‹ç¼©åŒ…
        if: steps.check-music.outputs.has_music == 'true'
        run: |
          # åˆ›å»ºæ—¶é—´æˆ³
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          ARCHIVE_NAME="music_backup_${TIMESTAMP}.zip"
          
          # åˆ›å»ºåŽ‹ç¼©åŒ…
          cd public/music
          zip -r "../../${ARCHIVE_NAME}" . -x "*.DS_Store" "*.Thumbs.db"
          cd ../..
          
          # æ˜¾ç¤ºåŽ‹ç¼©åŒ…ä¿¡æ¯
          ls -lh "${ARCHIVE_NAME}"
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV

      - name: å®‰è£…WebDAVå®¢æˆ·ç«¯
        if: steps.check-music.outputs.has_music == 'true'
        run: |
          # å®‰è£…rcloneç”¨äºŽWebDAVä¸Šä¼ 
          curl https://rclone.org/install.sh | sudo bash

      - name: é…ç½®WebDAVè¿žæŽ¥
        if: steps.check-music.outputs.has_music == 'true'
        run: |
          # åˆ›å»ºrcloneé…ç½®æ–‡ä»¶
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [webdav]
          type = webdav
          url = ${{ secrets.WEBDAV_URL }}
          vendor = other
          user = ${{ secrets.WEBDAV_USERNAME }}
          pass = ${{ secrets.WEBDAV_PASSWORD }}
          EOF

      - name: æµ‹è¯•WebDAVè¿žæŽ¥
        if: steps.check-music.outputs.has_music == 'true'
        run: |
          rclone lsd webdav: || echo "WebDAVè¿žæŽ¥æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®"

      - name: ä¸Šä¼ åˆ°äº‘ç›˜
        if: steps.check-music.outputs.has_music == 'true'
        run: |
          # åˆ›å»ºä¸Šä¼ è·¯å¾„
          UPLOAD_PATH="${{ github.event.inputs.upload_path || '/music/' }}"
          rclone mkdir "webdav:${UPLOAD_PATH}" || echo "ç›®å½•å¯èƒ½å·²å­˜åœ¨"
          
          # ä¸Šä¼ åŽ‹ç¼©åŒ…
          rclone copy "${ARCHIVE_NAME}" "webdav:${UPLOAD_PATH}" --progress
          
          # éªŒè¯ä¸Šä¼ 
          rclone ls "webdav:${UPLOAD_PATH}${ARCHIVE_NAME}"

      - name: æ¸…ç†æœ¬åœ°æ–‡ä»¶
        if: steps.check-music.outputs.has_music == 'true'
        run: |
          rm -f "${ARCHIVE_NAME}"

      - name: ä¸Šä¼ å®Œæˆé€šçŸ¥
        if: steps.check-music.outputs.has_music == 'true'
        run: |
          echo "âœ… éŸ³ä¹æ–‡ä»¶åŽ‹ç¼©å¹¶ä¸Šä¼ å®Œæˆï¼"
          echo "ðŸ“ ä¸Šä¼ è·¯å¾„: ${{ github.event.inputs.upload_path || '/music/' }}"
          echo "ðŸ“¦ åŽ‹ç¼©åŒ…: ${ARCHIVE_NAME}"
          echo "ðŸŽµ éŸ³ä¹æ–‡ä»¶æ•°é‡: ${{ steps.check-music.outputs.music_count }}"

      - name: æ— éŸ³ä¹æ–‡ä»¶æç¤º
        if: steps.check-music.outputs.has_music == 'false'
        run: |
          echo "â„¹ï¸ æœªå‘çŽ°éŸ³ä¹æ–‡ä»¶ï¼Œè·³è¿‡ä¸Šä¼ "
          echo "è¯·å°†éŸ³ä¹æ–‡ä»¶æ”¾ç½®åœ¨ public/music/ ç›®å½•ä¸‹"
